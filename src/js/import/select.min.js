class customSelect {

    constructor(option) {
        this.selector = option.selector;
        this.selectAll = document.querySelectorAll(this.selector)
    }

    init() {
        this.renderTemplate()
        this.clickEventOut()
    }

    reinit(elem) {
        const _this = this;


        document.querySelectorAll(elem).forEach(function (item, index) {


            item = item.parentNode

            if (item.querySelector('.select__styled')) {
                item.querySelector('.select__styled').remove()
                item.querySelector('.select__options').remove()
            }

            _this.renderOption(item)

        })

    }

    renderOption(item) {

        var _this = this;

        const title = item.querySelector('select').getAttribute('data-title');
        const icon = item.querySelector('select').getAttribute('data-icon');

        const styledSelect = document.createElement('div')
        styledSelect.classList.add('select__styled');
        styledSelect.innerHTML = '<span>Выберите</span>';

        const styledOptions = document.createElement('ul')
        styledOptions.classList.add('select__options');

        if(title){
            styledOptions.setAttribute('data-title', title);
        }

        item.appendChild(styledSelect)
        item.appendChild(styledOptions)

        _this.clickEventOpenSelect(item)

        item.querySelectorAll('select > option').forEach(function (item, index) {

            if (index == 0) {
                styledSelect.innerHTML = '<span class="text">' + item.innerText + '</span>';
            } else {
                const li = document.createElement('li')
                li.innerHTML = item.innerText
                li.setAttribute('rel', item.value)

                styledOptions.appendChild(li)

                _this.clickEventListItem(li)
            }

        })

        if(icon){
            styledSelect.classList.add('select__styled_icon');
            const span = document.createElement('span');
            span.classList.add('icon');
            span.innerHTML = "<svg width=\"20\" height=\"20\"><use xlink:href=\"/img/sprites/sprite.svg"+icon+"\"></use></svg>";
            styledSelect.prepend(span);
        }

    }

    renderTemplate() {

        const _this = this;

        this.selectAll.forEach(function (item, index) {
            if (!item.classList.contains('select__hidden')) {
                item.classList.add('select__hidden');
                const wrapper = document.createElement('div');
                wrapper.classList.add('af-select');
                wrapper.innerHTML = item.outerHTML;
                item.parentNode.replaceChild(wrapper, item);
            }

        })

        document.querySelectorAll('.af-select').forEach(function (item, index) {
            _this.renderOption(item);
        })
    }

    openSelect(elem) {

        var active = document.querySelector('.select__styled.select__styled_active');
        var activeOptions = document.querySelector('.select__options.select__options_active');

        if(active && activeOptions){
            active.classList.remove('select__styled_active');
            activeOptions.classList.remove('select__options_active');
        }

        elem.style.width = (elem.offsetWidth) + 'px'
        elem.querySelector('.select__styled').classList.toggle('select__styled_active')
        elem.querySelector('.select__options').classList.toggle('select__options_active')
    }

    closeSelect() {

        if (!document.querySelector('.select__styled_active')) return false

        document.querySelector('.select__styled_active').classList.remove('select__styled_active')
        document.querySelector('.select__options_active').classList.remove('select__options_active')
    }

    clickEventOut() {
        const _this = this;
        document.addEventListener('click', function () {
            _this.closeSelect()
        })
    }

    clickEventListItem(elem) {

        const parentElem = elem.parentNode.parentNode.parentNode
        const _this = this;

        elem.addEventListener('click', function (event) {

            event.stopPropagation()
            event.preventDefault()

            if (parentElem.querySelector('.select__options li.active')){
                parentElem.querySelector('.select__options li.active').classList.remove('active')
            }

            this.classList.add('active')
            parentElem.querySelector('.select__styled span.text').innerHTML = this.innerHTML
            parentElem.querySelector('select').value = this.getAttribute('rel')

            var event = new Event('change');
            parentElem.querySelector('select').dispatchEvent(event);

            _this.closeSelect()
        })
    }

    clickEventOpenSelect(elem) {
        const _this = this;

        elem.addEventListener('click', function (event) {
            event.stopPropagation()
            event.preventDefault()
            _this.openSelect(this)
        })
    }

}